<embed-nicetable>
    <rows>
        {% for task in qs %}
            <r>
                {% if not fixed_tasktype %}<d>{{task | model:'timed_a'}}</d>{% endif %}
                {% if not fixed_deal %}<d>{{task.deal | model:'a'}}<small> ({{task.deal.event | model:'a'}})</small></d>{% endif %}
                <d><small>{{task.deadline | deadline | or_cross}}</small></d>
                <d><small>{{task | model:'todo_state'}}</small></d>
                <d>
                    <small>
                        {% if task.todo_state_logged %}
                            {{task.tasklog_set.latest.date | timesince}}
                        {% else %}
                            <span class="label label-warning">Pas validé</span>
                        {% endif %}
                        <a class="btn btn-sm btn-link tooltip tooltip-right"
                            data-tooltip="Historique des états"
                            href="{% url 'prospector:tasks.history' pk=task.pk %}">
                            <i class="icon icon-time"></i>
                        </a>
                    </small>
                </d>
                <d>
                    <button class="btn btn-sm btn-link {% if task.taskcomment_set.exists %}badge{% endif %}"
                        data-badge="{{task.taskcomment_set.count}}"
                        onclick="getCommentModal({{task.pk}});">
                        <i class="icon icon-message"></i>
                    </button>
                </d>
                <d>
                    <div class="text-right mt-1">
                        {% for button, link in task.tasktype.useful_views_dict.items %}
                            <a class="btn btn-sm btn-primary mb-1" href="{% url link pk=task.pk %}">{{button}}</a>
                        {% endfor %}
                        <span class="state-buttons">
                            <form action="" method="post">
                                {% csrf_token %}
                                {% for prev in task.usual_prev_states %}
                                    <button type="submit"
                                            formaction="{% url 'prospector:tasks.set_todostate' pk=task.pk state=prev %}"
                                            data-tooltip="Basculer à {{prev | todo_state}}"
                                            class="btn btn-sm btn-error tooltip tooltip-left mb-1">
                                        {{prev | todo_state_short}}<i class="icon icon-arrow-left"></i>
                                    </button>
                                {% endfor %}
                                {% for next in task.usual_next_states %}
                                    <button type="submit"
                                            formaction="{% url 'prospector:tasks.set_todostate' pk=task.pk state=next %}"
                                            data-tooltip="Basculer à {{next | todo_state}}"
                                            class="btn btn-sm btn-success tooltip tooltip-left mb-1">
                                        {{next | todo_state_short}}<i class="icon icon-arrow-right"></i>
                                    </button>
                                {% endfor %}
                                {% if not task.todo_state_logged %}
                                    <button type="submit"
                                            formaction="{% url 'prospector:tasks.log_todostate' pk=task.pk %}"
                                            data-tooltip="Valider le nouvel état"
                                            class="btn btn-sm btn-primary tooltip tooltip-left mb-1">
                                        <i class="icon icon-check"></i>
                                    </button>
                                {% endif %}
                            </form>
                        </span>
                    </div>
                </d>
            </r>
        {% endfor %}
    </rows>
    <other>
        <div class="modal fade" id="mymodal">
            <a href="#close" class="modal-overlay" aria-label="Close"></a>
            <div class="modal-container">
                <!-- content here. -->
            </div>
        </div>
    </other>
    <script>
        // The table's placeholder must be a <remote-nicetable> tag with id #tasks_list_remote.
        var columns = [{% if not fixed_tasktype %}'Nom', {% endif %}{% if not fixed_deal %}'Deal', {% endif %}'Échéance', 'État', 'État validé depuis', 'Commentaire', '<search>'];
        var t = new NiceTable($('#tasks_list_remote'), columns);

        function setupCallbacks(){
            $('.state-buttons form', t.rowsTbody).on('submit', function(event){
                event.preventDefault(); // Don't open a new page on submit.
                $.post(
                    $(event.submitter).attr('formaction'),
                    $(event.target).serialize(),
                    function(response){
                        t.refreshRemoteRows(setupCallbacks);
                    }
                );
                return false; // Don't open a new page on submit.
            });
        }
        setupCallbacks();

        function getCommentModal(task_pk){
            $.get(
                '{% url "prospector:tasks.comments" pk=42 %}'.replace(42, task_pk),
                function(response){
                    $('#mymodal .modal-container').empty();
                    $('#mymodal .modal-container').append(response);
                    setupCommentsCallbacks();
                    location.hash = '#mymodal';
                }
            );
        }

        function setupCommentsCallbacks(){
            $('.delete-form', '#mymodal').on('submit', function(event){
                event.preventDefault();
                $.post(
                    $(event.submitter).attr('formaction'),
                    $(event.target).serialize(),
                    function(response){
                        location.hash = '#close';
                        t.refreshRemoteRows(setupCallbacks);
                    }
                );
                return false; // Don't open a new page on submit.
            });
            $('.post-form', '#mymodal').on('submit', function(event){
                event.preventDefault();
                $.post(
                    $(event.target).attr('action'),
                    $(event.target).serialize(),
                    function(response){
                        location.hash = '#close';
                        t.refreshRemoteRows(setupCallbacks);
                    }
                );
                return false; // Don't open a new page on submit.
            });
        }

    </script>
</embed-nicetable>
